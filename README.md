# Скрипты для объединения нескольких видеофайлов с регистратора в один и создание тайлампса для экономного архивирования.
Написаны для регистратора 70Mai Midrive D06.
Для перекодирования использую [ffmpeg](https://www.ffmpeg.org/download.html).
Сливаю видеозаписи за один заданный день в один файл. Делаю копию видео ускоренного в 8 раз.
В ffmpeg для декодирования(чтение видео) использую опцию аппаратного ускорение CUDA (для видеокарт Nvidia).
При наличии дискретной видеокарты, заметно ускоряет процесс перекодирования.
---
## Использование:
Запустить `auto_1.cmd`.
Файлы по умолчанию сохраняются в папку `"videos"`.
Получишь файлы вида:
- `"videos\20220730-1750.mkv"` - объединенные в один файл все видеозаписи с камеры за дату 2022-05-17
- `"videos\20220730-1750_x8"` - копия `20220730-1750.mkv` ускоренного в 8 раз

Скрипт запоминает даты обработанных файлов. И при следующем запуске, пропускает их.
    
Настройки:
- Буква диска регистратора по умолчанию `D:`:
`set dashcam_drive=D:`;
- Файлы по умолчанию сохраняются в папку `"videos"`:
`set videos_dir=videos`.

## Дополнительные скрипты
### `wholedir.cmd` Объединяет все файлы в указанной директории в один файл. И делает ускоренную копию.
В консоли 1-ым параметром к скрипту передается обрабатываемая директория.
Если не указан параметр, используется текущая директория.

Настройки:
- `set filemask=????-??-??_x8.mkv` - маска обрабатываемых файлов;
- `set filename_concat=filename_concat.mkv` - имя файла после объединения;
- `set filename_speed=filename_concat_x8.mkv` - имя файла ускоренного в 8 раз, можно не указывать, тогда скрипт не будет делать конвертацию.

## Используемые файлы:
- `"videos"` - папка для сохранения видео; 
- `auto_1.cmd` - основной скрипт запуска;
- `auto_2_concat.cmd` - соединение все видеозаписей из папок "Event", "Normal" регистратора в один файл mkv;
- `auto_3_convert.cmd` - конвертирование видео в ускоренное в 8 раз. Включена опция аппаратного декодирования CUDA;  
- `custom_date.cmd` - скрипт, где дата задается вручную;
- `timer.cmd` - врапер для замера времени выполнения скриптов;
- `timer.ps1` - врапер для замера времени выполнения скриптов;
- `wholedir.cmd` - объединяет и делают ускоренную копию в указанной директории или текущей.

## `auto_1.cmd` Оcновной файл запуска.

 - Работает с видеозаписями из папок `"Event"`, `"Normal"` регистратора;
 - Используются дополнительные скрипты последовательно:
   - `auto_2_concat.cmd` - соединение все видеозаписей в один файл mkv;
   - `auto_3_convert.cmd` - конвертирование видео в ускоренное в 8 раз.


##  `custom_date.cmd`. Дата задается вручную 

- Работает с видеозаписями из папок `"Event"`, `"Normal"` регистратора;
- Используются дополнительные скрипты последовательно:
  - `custom_date_2_concat.cmd` - соединение все видеозаписей в один файл mkv;
  - `custom_date_3_convert.cmd` - конвертирование видео в ускоренное в 8 раз.

## Регистратор 70Mai Midrive D06
- Video: h264 (Main) (avc1 / 0x31637661), yuv420p(tv, progressive), 1920x1088, 28394 kb/s, 29.10 fps, 29.08 tbr, 1k tbn (default)
- Audio: adpcm_ima_wav (ms[0][17] / 0x1100736D), 16000 Hz, stereo, s16p, 128 kb/s (default)
- mp4 format

Регистратор пишет файлы по 2 минуты(задается в настройках) на карту MicroSD.
В папки:
- `"Event"` - если сработал датчик удара (G-датчик), защищенные от стирания файлы,
файлы именуются с префиксом `EMER` типа: `EMER20220422-121643-000487.MP4`;
- `"Normal"` - обычные записи, перезаписываемые по кругу файлы, 
файлы именуются с префиксом `FILE` типа: `FILE20220422-121242-000485.MP4`.

## NVIDIA CUDA
Для ffmpeg в файле `t_speed8_cuda.cmd` указана опция аппаратного декодирования (чтение видео) на GPU NVIDIA
`-hwaccel cuda` (только для карт NVIDIA).
Рекомендую использовать при наличии дискретной видеокарты. Заметно ускоряет перекодирование. 
Экономит ресурсы CPU, которые используются для более ресурсоемкой задачи кодирования. 
Для отключения просто удали эту опцию. Или поменяй на другой метод аппаратного декодирования подходящий видеокарте.
Примеры опций аппаратного кодирования/декодирования:
- `-hwaccels` - показывает доступные методы аппаратного ускорения;
- `-hwaccel cuda` - декодирование CUDA NVIDIA;
- `-hwaccel_device 0 -hwaccel cuda` - декодирование CUDA NVIDIA на видеокарте 0;
- `-hwaccel d3d11va` - декодирование через API DirectX 11, автоматически выбирает используемое устройство(Intel, AMD, NVIDIA);
подходит для дискретных видеокарт AMD, к примеру, на лаптопе с двумя видеокартами NVIDIA GeForce RTX 3050 Laptop GPU и интегрированной AMD Radeon(TM) Graphics, отдает предпочтение AMD(хотя она идет с индексом 1),
- `-c:v h264_nvenc -b:v 20M -2pass true` - кодирование на GPU NVIDIA, быстрее чем CPU, качество хуже, значительно завышает битрейт и увеличивает размер файла.

## MKV
Для видео файлов использую контейнер `mkv` как наименее прихотливый.
Контейнер `mp4` не поддерживает кодек PCM, c которым пишет регистратор, о чем ffmpeg сообщает ошибкой:
```
[mp4 @ 000001e0ce35f680] Could not find tag for codec adpcm_ima_wav in stream #1, codec not currently supported in container
Could not write header for output file #0 (incorrect codec parameters ?): Invalid argument
Error initializing output stream 0:1 --
```

### Если все же хочется сливать все файлы в один `mp4`, нужно перекодировать аудио.

- В файле `auto_2_concat.cmd` заменить команду ffmpeg:
```
%cmd_ffmpeg% -f concat -safe 0 -i %tmp% -c:v copy -c:a aac "%filename_concat%"
```

- В файле `auto_1.cmd` заменить расширения `mkv`->`mp4`:
```
set filename_concat=%videos_dir%\!dt!.mkv
set filename_speed=%videos_dir%\!dt!_x8.mkv
```

### Если надо получить в mp4 только ускоренное видео, тогда еще проще.
Достаточно заменить одно расширение в файле `auto_1.cmd`:
```
set filename_speed=%videos_dir%\!dt!_x8.mp4
```